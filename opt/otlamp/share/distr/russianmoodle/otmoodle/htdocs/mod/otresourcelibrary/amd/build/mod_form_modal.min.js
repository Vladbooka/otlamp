define(["jquery","core/ajax","core/templates","core/notification","core/str","core/modal_factory","core/yui"],function(a,b,c,d,e,f,g){return{_breadcrumbs:[],_oldbreadcrumbs:[],_iframeuri:null,_courseid:null,_dialogue:[a.Deferred(),a.Deferred(),a.Deferred()],_containers:[],_hidden:null,_button:null,_searchtext:null,_categoryid:null,_sourcenames:null,_showquantity:10,_showstartid:0,enableButton:function(){this._button.removeClass("disabled")},disableButton:function(){this._button.addClass("disabled")},saveInModForm:function(b,c,d,e,f,g){var h=this._containers.sr.find("div.otrl_material");if(h.length>0)if(""==b||void 0===b||""==c||void 0==c)this._hidden.val("");else{var i={};i.sourcename=b,i.resourceid=c,void 0===d||""==d?i.pagenum=0:i.pagenum=d,void 0===e||""==e?i.chapter=0:i.chapter=e,void 0===f||""==f?i.fragment=0:i.fragment=f,this._hidden.val(JSON.stringify(i));var j=a(".otrl_sourcename_info"),k=a(".otrl_resource_info");j.empty(),k.empty(),j.text(b),k.text(g)}},InsertSearchResults:function(a,e,f,g){var h=this;e?(h._containers.sr.find("#search_results").empty().append("<div class='loading'></div>"),h._categoryid=f,h._searchtext=a,h._sourcenames=g,h._showstartid=0):(h._showstartid=h._showstartid+h._showquantity,h._containers.sr.find("#otrl_more_holder>div").addClass("loading"));var i={sourcenames:h._sourcenames,categoryid:h._categoryid,q:h._searchtext,courseid:h._courseid,showstartid:h._showstartid,showquantity:h._showquantity},j=b.call([{methodname:"mod_otresourcelibrary_insert_search_results",args:i}]);j[0].done(function(a){var b=JSON.parse(atob(a));h.RenderContent("search_results",b,function(a,b){var d=h._containers.sr.find("#search_results");e?d.empty():h._containers.sr.find("#otrl_more_holder").remove(),c.appendNodeContents(d,a,b),h.initAfterSearchResults()})}).fail(function(a){h._containers.sr.find(".loading").removeClass("loading"),d.exception(a)})},InsertSearchHeader:function(){var a=this,e=b.call([{methodname:"mod_otresourcelibrary_insert_search_header",args:{data:"here can bee data"}}]);e[0].done(function(b){var d=JSON.parse(atob(b));a.RenderContent("search_header",d,function(b,d){a._containers.sr.empty(),c.appendNodeContents(a._containers.sr,b,d),a.getDialogueSR().done(function(a){a.set("width","auto"),a.set("height","100%")}),a._dialogue[2].resolve(),a._containers.sr.closest("div.moodle-dialogue").addClass("moodle-dialogue-otresourcelibrary-material_search"),a.initAfterSearchHeader()})}).fail(function(b){a._containers.sr.find(".loading").removeClass("loading"),d.exception(b)})},InsertMaterialPreview:function(a,b,d,e,f,g,h){var i=this;i._iframeuri="/mod/otresourcelibrary/view.php?co=1&force=embeded&cid="+i._courseid+"&sourcename="+a+"&resourceid="+b;var j="";if(void 0===f)var k=0;else{var k=1;""!=f&&(j="&pointertype=fragment&pointerval="+f+"#"+f)}if(void 0===e)var l=0;else{var l=1;""!=e&&(j="&pointertype=chapter&pointerval="+e+"#"+e)}if(void 0===d)var m=0;else{var m=1;""!=d&&(j="&pointertype=pagenum&pointerval="+d+"#"+d)}var n=i._iframeuri+j,o={key:h,title:g,urltoview:encodeURI(n),fragmentvalue:f,chaptervalue:e,pagenumvalue:d,fragment:k,chapter:l,pagenum:m};i.RenderContent("material_preview",o,function(a,b){i._containers.mp.empty(),c.appendNodeContents(i._containers.mp,a,b),i.getDialogueMP().done(function(a){a.set("width","auto"),a.set("height","100%")}),i._containers.mp.closest("div.moodle-dialogue").addClass("moodle-dialogue-otresourcelibrary-material_preview"),i.initAfterMaterialPreview()})},InsertSectionSelection:function(){var a=this,e=b.call([{methodname:"mod_otresourcelibrary_insert_section_selection",args:{}}]);e[0].done(function(b){a._dialogue[2].done(function(){var d=JSON.parse(atob(b));a.RenderContent("section_selection",d,function(b,d){a._containers.ss.empty(),c.appendNodeContents(a._containers.ss,b,d),a.initAfterSectionSelection(),a.SetCategorySelected()})})}).fail(function(a){d.exception(a)})},InsertCategorySelection:function(a){var e=this;e._containers.ss.find(".otrl_source").addClass("loading");var arguments={};void 0!=a&&(arguments.sourcename=a);var f=e._containers.ss.find("#otrl_category_selection");f.empty().hide();var g=b.call([{methodname:"mod_otresourcelibrary_insert_category_selection",args:arguments}]);g[0].done(function(a){var b=JSON.parse(atob(a));e.RenderContent("category_selection",b,function(a,b){f.hide(),/^\s*$/.test(a)||(c.appendNodeContents(f,a,b),f.show()),e._containers.ss.find(".otrl_source").removeClass("loading"),e.initAfterCategorySelection(),e.SetCategorySelected()})}).fail(function(a){e._containers.sr.find(".loading").removeClass("loading"),d.exception(a)})},InsertSubcategories:function(a){var e=this;e._containers.sub.append("<div class='otrl_subcategory_holder'><div class='loading'></div></div>");var f=b.call([{methodname:"mod_otresourcelibrary_insert_subcategories",args:{sourcename:a.sourcename,parentid:a.catid}}]);f[0].done(function(a){var b=JSON.parse(atob(a));e.RenderContent("subcategories",b,function(a,d){e._containers.sub.empty(),c.appendNodeContents(e._containers.sub,a,d),b.subcategories[0].subcategory.level>1?e._containers.ss.find(".otrl_cat1nd, .otrl_cat2nd").addClass("otrl_subcat"):e._containers.ss.find(".otrl_cat1nd, .otrl_cat2nd").removeClass("otrl_subcat"),e.initAfterSubcategories(),e.SetCategorySelected()})}).fail(function(a){e._containers.sr.find(".loading").removeClass("loading"),d.exception(a)})},InsertBreadcrumbs:function(a,b){var d=this;if(""!=a){var e=JSON.parse(atob(a));if(0==e.parentid&&d._breadcrumbs.splice(1,d._breadcrumbs.length-1),d._breadcrumbs.length>=1){var f=d._breadcrumbs[d._breadcrumbs.length-1].categorydata;""!=f&&(f=JSON.parse(atob(f)),e.parentid==f.parentid&&d._breadcrumbs.pop()),d._breadcrumbs.forEach(function(a,b){if(""!=a.categorydata){var c=JSON.parse(atob(a.categorydata));c.catid==e.catid&&d._breadcrumbs.splice(b,d._breadcrumbs.length-1)}}),""!=d._breadcrumbs[0].categorydata&&d._breadcrumbs.unshift({catname:e.sourcename,categorydata:""})}d._breadcrumbs.push({catname:b,categorydata:a})}else d._breadcrumbs=[],d._breadcrumbs.push({catname:b,categorydata:""});d.RenderContent("breadcrumbs",{breadcrumbs:d._breadcrumbs},function(a,b){d._containers.bread.empty(),c.appendNodeContents(d._containers.bread,a,b),d.initAfterBreadcrumbs()})},SetCategorySelected:function(){var a=this;a._containers.ss.find(".otrl_sources .otrl_source").removeClass("otrl_selected");var b=a.getCurrentSourceItem();null!==b&&b.addClass("otrl_selected")},RenderContent:function(a,b,e){var f=this;c.render("otresourcelibrary/"+a,b).then(function(a,b){e(a,b)}).fail(function(a){f._containers.sr.find(".loading").removeClass("loading"),d.exception(a)})},initAfterBreadcrumbs:function(){var b=this,d=b._containers.sr.find(".btn-select-category");d.off("click"),d.on("click",function(){b._containers.sr.off("mouseup"),b.SearchInputDisabled(),b._containers.bread=b._containers.sr.find(".otrl_breadcrumbs"),b.RenderContent("breadcrumbs",{breadcrumbs:b._breadcrumbs},function(a,d){b._containers.bread.empty(),c.appendNodeContents(b._containers.bread,a,d),b.initAfterBreadcrumbs()}),b._containers.ss.find("#otrl_category_selection").attr({style:"display:none"}),a(this).attr({style:"display:none"});var d=b.getCurrentCategoryId(),e=b.getCurrentSourcename();b.InsertSearchResults(b._searchtext,!0,d,e)});var e=b._containers.sr.find(".otrl_breadcrumbs .breadcrumb a");e.off("click"),e.on("click",function(){b._containers.ss.find("#otrl_category_selection").attr({style:"display:none"}),b._containers.sr.find(".btn-select-category").attr({style:"display:none"});var c=a(this).find("span").text(),d=a(this).attr("data");if(b.InsertBreadcrumbs(d,c),b.SearchInputDisabled(),b.SetCategorySelected(),""!=d){d=JSON.parse(atob(d)),0==d.parentid?b.InsertCategorySelection(d.sourcename):(b._containers.sub.empty(),b.InsertSubcategories(d));var e=b.getCurrentCategoryId(),f=b.getCurrentSourcename();b.InsertSearchResults(b._searchtext,!0,e,f)}else b.InsertSearchResults(b._searchtext,!0,null,c);b._containers.ss.find("#otrl_category_selection").attr({style:"display:none"}),b._containers.sr.find(".btn-select-category").attr({style:"display:none"})})},getLastBreadcrumbsItem:function(){var a=this,b=null;return a._breadcrumbs.length>0&&(b=a._breadcrumbs[a._breadcrumbs.length-1]),b},getCurrentCategory:function(){var a=this,b=null,c=a.getLastBreadcrumbsItem();if(null!==c&&""!=c.categorydata){var b=c;b.decodedinfo=JSON.parse(atob(b.categorydata))}return b},getCurrentCategoryId:function(){var a=this,b=null,c=a.getCurrentCategory();return null!==c&&(b=c.decodedinfo.catid),b},getCurrentSourcename:function(){var a=this,b=null,c=a.getLastBreadcrumbsItem();return null!==c&&(""!=c.categorydata?(c.decodedinfo=JSON.parse(atob(c.categorydata)),b=c.decodedinfo.sourcename):b=c.catname),b},getCurrentSourceItem:function(){var b=this,c=null,d=b.getCurrentSourcename();return b._containers.ss.find(".otrl_sources .otrl_source").each(function(){if(a(this).html()==d)return void(c=a(this))}),c},getCurrentCategorySourceItem:function(){var b=this,c=null,d=b.getCurrentCategory();if(null!==d){var e=d.decodedinfo.sourcename;b._containers.ss.find(".otrl_sources .otrl_source").each(function(){if(a(this).html()==e)return void(c=a(this))})}return c},SearchInputDisabled:function(){var a=this,b=a._containers.sr.find('input[name="otrl_searchinput"]'),c=a._containers.sr.find("input.otrl_search_button"),d=a.getCurrentCategorySourceItem();null!==d&&1!=d.data("feature-search_in_category")?(a._searchtext=null,b.val("").attr("disabled",!0),c.attr("disabled",!0)):(b.removeAttr("disabled"),c.removeAttr("disabled"))},initAfterSubcategories:function(){var b=this,c=b._containers.sub.find(".otrl_category .otrl_hassubcat");c.off("click"),c.on("click",function(){b._containers.sub.empty();var c=a(this).closest(".otrl_category").attr("data");b.InsertBreadcrumbs(c,a(this).text()),c=JSON.parse(atob(c)),b.InsertSubcategories(c)});var d=b._containers.sub.find(".otrl_category .otrl_nosubcat");d.off("click"),d.on("click",function(){d.removeClass("otrl_selected"),a(this).addClass("otrl_selected");var c=a(this).closest(".otrl_category").attr("data");b.InsertBreadcrumbs(c,a(this).text())})},initAfterCategorySelection:function(){var b=this;b._containers.bread=a(".otrl_breadcrumbs"),b._containers.sub=a(".otrl-section-selection-container #otrl_subcategories");var c=b._containers.ss.find(".otrl_category0 a");c.off("click"),c.on("click",function(){b._containers.sub.empty();var c=a(this).closest(".otrl_category0"),d=c.attr("data");b.InsertBreadcrumbs(d,a(this).text()),c.data("has-children")&&(d=JSON.parse(atob(d)),b.InsertSubcategories(d))}),b._containers.sr.mouseup(function(a){var c=b._containers.ss.find("#otrl_category_selection");c.is(a.target)||0!==c.has(a.target).length||b._containers.sr.find(".btn-select-category").is(a.target)||b._containers.ss.find(".otrl_sources .otrl_source").is(a.target)||(b._containers.sr.off("mouseup"),c.attr({style:"display:none"}),b.RestoreBreadcrumbs(),b.SetCategorySelected())})},initAfterSectionSelection:function(){var b=this;b._containers.bread=a(".otrl_breadcrumbs");var c=b._containers.ss.find(".otrl_sources .otrl_source");c.off("click"),c.on("click",function(){b.SaveBreadcrumbs(),b.InsertCategorySelection(a(this).text()),b.InsertBreadcrumbs("",a(this).text()),b._containers.sr.find(".btn-select-category").removeAttr("style")})},SaveBreadcrumbs:function(){var a=this;a._oldbreadcrumbs=a._breadcrumbs},RestoreBreadcrumbs:function(){var a=this;a._breadcrumbs=a._oldbreadcrumbs,a.RenderContent("breadcrumbs",{breadcrumbs:a._breadcrumbs},function(b,d){a._containers.bread.empty(),a._containers.sr.find(".btn-select-category").attr({style:"display:none"}),c.appendNodeContents(a._containers.bread,b,d),a.initAfterBreadcrumbs()})},initAfterMaterialPreview:function(){var b=this,c=b._containers.mp.find(".otrl_material_btn_holder .btn-secondary");c.off("click"),c.on("click",function(){b.getDialogueMP().done(function(a){a.hide()})});var d=b._containers.mp.find(".otrl_material_btn_holder .btn-primary");d.off("click"),d.on("click",function(){var c=a(this).closest("div.otrl_material"),d=b.getInputAndMaterialData(c);b.saveInModForm(d.sourcename,d.resourceid,d.pagenum,d.chapter,d.fragment,d.title),b.getDialogueSR().done(function(a){a.hide()}),b.getDialogueMP().done(function(a){a.hide()})});var e=b._containers.mp.find(".anchors input"),f=b._containers.mp.find(".otrl_iframe iframe");f.on("load",function(){var b=f.attr("src");if(b.indexOf("#")>0){var c=b.substring(b.indexOf("#")+1);if(""!=c&&f.contents().find("#"+c).length>0){var d=a("#"+c,f.contents()).offset().top;f.contents().find("body").animate({scrollTop:d},1e3)}}}),e.focusout(function(){var c=a(this),d=b._iframeuri,g=c.val();if(""!=g){var h=c.attr("name").replace("material_","");d=d+"&pointertype="+h+"&pointerval="+g+"#"+g,f.attr("src",d);for(var i=0;i<e.length;++i)a(e[i]).attr("name")!=c.attr("name")&&a(e[i]).val("")}})},initAfterSearchHeader:function(){var b=this,c=b._containers.sr.find('input[name="otrl_searchinput"]');a(document).off("click touchstart","input.otrl_search_button").on("click touchstart","input.otrl_search_button",function(){b.searchHandler(c.val())}),c.keydown(function(a){13==a.keyCode&&(a.preventDefault(),b.searchHandler(c.val()))}),b._containers.ss=a(".otrl-section-selection-container");var d=b._containers.sr.find(".otrl_select_category");d.off("click"),d.on("click",function(){b._breadcrumbs=[],a(".otrl_breadcrumbs").empty(),b._containers.ss.find(".otrl_source").removeClass("otrl_selected"),b._categoryid=null,b._sourcenames=null,b.SearchInputDisabled(),b._containers.ss.find("#otrl_category_selection").empty().attr({style:"display:none"}),b._containers.sr.find(".btn-select-category").attr({style:"display:none"}),b.InsertSearchResults(b._searchtext,!0)})},initAfterSearchResults:function(){var b=this,c=b._containers.sr.find(".otrl_material_btn_holder .btn-primary");c.off("click"),c.on("click",function(){var c=a(this).closest("div.otrl_material"),d=b.getInputAndMaterialData(c);b.saveInModForm(d.sourcename,d.resourceid,d.pagenum,d.chapter,d.fragment,d.title),b.getDialogueSR().done(function(a){a.hide()})});var d=b._containers.sr.find("#otrl_more_holder>div");d.off("click"),d.on("click",function(){b.InsertSearchResults(b._searchtext,!1)}),b._containers.sr.find(".spoiler-body").hide(300),b._containers.sr.off("click",".spoiler-head"),b._containers.sr.on("click",".spoiler-head",function(b){b.preventDefault(),a(this).parents(".spoiler-wrap").toggleClass("active").find(".spoiler-body").slideToggle()}),e.get_strings([{key:"preview_header",component:"mod_otresourcelibrary"}]).done(function(a){b.getDialogueMP().done(function(b){b.set("headerContent",a[0])})});var f=b._containers.sr.find(".otrl_material_btn_holder .btn-secondary");f.off("click"),f.on("click",function(c){c.preventDefault();var d=a(this).closest("div.otrl_material"),e=b.getInputAndMaterialData(d);b.getDialogueMP().done(function(c){c.show(),b._containers.mp=a(".otrl-material-preview-container"),b.InsertMaterialPreview(e.sourcename,e.resourceid,e.pagenum,e.chapter,e.fragment,e.title,e.selectedmaterial)})});var g=b._containers.sr.find(".anchors input");g.focusout(function(){var b=a(this),c=b.val();if(""!=c)for(var d=0;d<g.length;++d)a(g[d]).attr("name")!=b.attr("name")&&a(g[d]).val("")})},searchHandler:function(a){var b=this;b.InsertSearchResults(a,!0,b._categoryid,b._sourcenames)},getInputAndMaterialData:function(a){var b=[];b.pagenum=a.find("input[name='material_pagenum']").val(),b.chapter=a.find("input[name='material_chapter']").val(),b.fragment=a.find("input[name='material_fragment']").val(),b.title=a.find(".material_name .name").text(),b.selectedmaterial=a.attr("data");var c=JSON.parse(atob(b.selectedmaterial));return b.sourcename=c.sourcename,b.resourceid=c.resourceid,b},dialogConfig:function(a){var b=g.Node.create("<img />").setAttribute("src",M.util.image_url("i/loading","moodle")).addClass("spinner"),c={headerContent:"&nbsp;",bodyContent:g.Node.create("<div />").addClass(a).append(b),draggable:!1,visible:!1,center:!0,modal:!0,width:"400px",height:"200px"};return c},getDialogueSR:function(){var a=this;return"resolved"!=a._dialogue[0].state()&&g.use("moodle-core-notification",function(){var b="otrl-search-results-container";a._dialogue[0].resolve(new M.core.dialogue(a.dialogConfig(b)))}),a._dialogue[0].promise()},getDialogueMP:function(){var a=this;return"resolved"!=a._dialogue[1].state()&&g.use("moodle-core-notification",function(){var b="otrl-material-preview-container";a._dialogue[1].resolve(new M.core.dialogue(a.dialogConfig(b)))}),a._dialogue[1].promise()},init:function(b){var c=this;c._courseid=b;var f=a("form.mform.mod_otresourcelibrary-js").first();c._hidden=f.find('input[name="khipu_setting"]').first(),c._button=f.find(".otresourcelibrary_settings_button").first(),e.get_strings([{key:"modal_form_header",component:"mod_otresourcelibrary"}]).done(function(a){c.getDialogueSR().done(function(b){b.set("headerContent",a[0])})}).fail(d.exception).always(function(){c.enableButton.call(c)}),c._button.off("click").on("click",function(b){b.preventDefault(),c._containers.sr&&c._containers.sr.empty(),c._dialogue[2]=a.Deferred(),c.disableButton(),c.getDialogueSR().done(function(b){b.show(),c._containers.sr=a(".otrl-search-results-container"),c.enableButton(),c.InsertSearchHeader(),c.InsertSectionSelection()})})}}});