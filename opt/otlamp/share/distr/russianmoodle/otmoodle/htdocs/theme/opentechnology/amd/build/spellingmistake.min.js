define ("theme_opentechnology/spellingmistake",["jquery","core/ajax","core/str","theme_opentechnology/flashmessage"],function(a,b,c,d){return{body:a("body"),forbiddenTags:["script","style","frame","iframe","meta","link","img"],entityMap:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"},STRINGS:{spelling_mistake_modal_title:"...progress",spelling_mistake_modal_question_one:"...progress",spelling_mistake_modal_question_two:"...progress",spelling_mistake_modal_comment_placeholder:"...progress",spelling_mistake_modal_close:"...progress",spelling_mistake_modal_ok:"...progress",spelling_mistake_modal_success:"...progress",spelling_mistake_modal_fail:"...progress"},ORFOMODAL:null,label:function label(a){var b=this;return b.STRINGS[a]},clearText:function clearText(a){var b=this;if(/\S/.test(a)){return a.replace(/(\r\n|\n|\r)/gm," ").replace(/\s+/g," ").replace(/[&<>"'\/]/g,function(a){return b.entityMap[a]})}},extractTextFromNode:function extractTextFromNode(b){for(var c=this,d=0;d<c.forbiddenTags.length;d++){a(c.forbiddenTags[d],b).remove()}var e=b.innerHTML.replace(/</gm," <"),f=new DOMParser().parseFromString(e,"text/html").body.innerText||"";f=f.replace(/(\n|\r)/gm," ").replace(/^\s+|\s+$/g,"").replace(/\s{2,}/g," ");return f},extractTextFromRange:function extractTextFromRange(a){var b=this,c="";try{for(var d=a.cloneContents(),e=d.children||d.childNodes,f=[],g=0,h=e.length,j;g<h;g++){j=b.extractTextFromNode(e[g]);if(/\S/.test(j)){f.push(j)}}c=f.join(" ")}catch(d){c=b.clearText(a.toString())}return c},getSelectionText:function getSelectionText(a){var b=this,c="";if(a===void 0){a=window}var d=a.document;if(a.getSelection){c=a.getSelection().toString()}else if(d.selection&&"Control"!=d.selection.type){c=d.selection.createRange().text}return b.clearText(c)},getSelectedPhrase:function getSelectedPhrase(){var b=this;try{var c=[],d=[],e;if(window.getSelection){e=getSelection();for(var f=0,g=e.rangeCount;f<g;f++){var h=e.getRangeAt(f),j=h.startContainer,k=h.endContainer;if(j){c.push("#text"===j.nodeName?j.parentNode:j)}if(k){c.push("#text"===k.nodeName?k.parentNode:k)}}if(0===c.length){c=[e.anchorNode]}}if(!c.length&&document.selection){e=document.selection;var l=e.getRangeAt?e.getRangeAt(0):e.createRange(),m=l.commonAncestorContainer?l.commonAncestorContainer:l.parentElement?l.parentElement():l.item(0);if(m){c=[m]}}for(var f=0,n=c.length,m;f<n;f++){m=c[f];if("#text"==m.nodeName){m=m.parentNode}try{d.push(b.extractTextFromNode(m.cloneNode()))}catch(b){d.push(a(m).text())}}return d.join(" ")}catch(a){}},getAroundSelectedText:function getAroundSelectedText(a){var b=this;if(!a){a=b.body.get(0)}var c,d,e,f="",g="";if("undefined"!=typeof window.getSelection){c=window.getSelection();if(c.rangeCount){d=c.getRangeAt(0)}else{d=document.createRange();d.collapse(!0)}e=document.createRange();e.selectNodeContents(a);e.setEnd(d.startContainer,d.startOffset);f=b.extractTextFromRange(e);e.selectNodeContents(a);e.setStart(d.endContainer,d.endOffset);g=b.extractTextFromRange(e)}else if((c=document.selection)&&"Control"!=c.type){d=c.createRange();e=document.body.createTextRange();e.moveToElementText(a);e.setEndPoint("EndToStart",d);f=b.clearText(e.text||"");e.moveToElementText(a);e.setEndPoint("StartToEnd",d);g=b.clearText(e.text||"")}return{before:f,after:g}},displayModal:function displayModal(b){var c=this,d="<div class=\"opentechnology-modal moodle-has-zindex\" tabindex=\"-1\" style=\"display: block;\"><div class=\"opentechnology-modal-dialog moodle-has-zindex\"><div class=\"opentechnology-modal-content\"><div class=\"opentechnology-modal-header\"><h2 class=\"opentechnology-modal-header-info\">"+c.label("spelling_mistake_modal_title")+"</h2><div class=\"opentechnology-modal-header-close moodle-has-zindex\"></div></div><div class=\"opentechnology-modal-body\"><div class=\"opentechnology-modal-drama\">&laquo;"+b+"&raquo;</div><div>"+c.label("spelling_mistake_modal_question_one")+"</div><input placeholder=\""+c.label("spelling_mistake_modal_comment_placeholder")+"\" name=\"comment\" type=\"text\" style=\"margin-bottom:0 !important;\"></div><div class=\"opentechnology-modal-footer\"><button class=\"button btn btn-primary\" type=\"button\" role=\"submit\">"+c.label("spelling_mistake_modal_ok")+"</button>\r\n<button class=\"button btn btn-primary\" type=\"button\" role=\"close\">"+c.label("spelling_mistake_modal_close")+"</button>\r\n<div class=\"opentechnology-notice\">"+c.label("spelling_mistake_modal_question_two")+"</div></div></div></div>"+"</div>".replace(/(\n|\r|\r\n)/gm,"").replace(/\s+/g," ");c.ORFOMODAL=a(d);c.body.addClass("opentechnology-modal-open").append(c.ORFOMODAL);return c.ORFOMODAL},hideModal:function hideModal(){var a=this;a.body.removeClass("opentechnology-modal-open");if(a.ORFOMODAL&&0<a.ORFOMODAL.length){a.ORFOMODAL.remove()}},setStrings:function setStrings(){var a=this;c.get_strings([{key:"spelling_mistake_modal_title",component:"theme_opentechnology"},{key:"spelling_mistake_modal_question_one",component:"theme_opentechnology"},{key:"spelling_mistake_modal_question_two",component:"theme_opentechnology"},{key:"spelling_mistake_modal_comment_placeholder",component:"theme_opentechnology"},{key:"spelling_mistake_modal_close",component:"theme_opentechnology"},{key:"spelling_mistake_modal_ok",component:"theme_opentechnology"},{key:"spelling_mistake_modal_success",component:"theme_opentechnology"},{key:"spelling_mistake_modal_fail",component:"theme_opentechnology"}]).done(function(b){a.STRINGS.spelling_mistake_modal_title=b[0];a.STRINGS.spelling_mistake_modal_question_one=b[1];a.STRINGS.spelling_mistake_modal_question_two=b[2];a.STRINGS.spelling_mistake_modal_comment_placeholder=b[3];a.STRINGS.spelling_mistake_modal_close=b[4];a.STRINGS.spelling_mistake_modal_ok=b[5];a.STRINGS.spelling_mistake_modal_success=b[6];a.STRINGS.spelling_mistake_modal_fail=b[7]})},keydownHandler:function keydownHandler(c){var e=this;if((c.ctrlKey||c.metaKey)&&13==c.keyCode){var f=c.currentTarget,g=f.parentWindow||f.defaultView,h=e.getSelectionText(g);if(h!==void 0&&/\S/.test(h)&&1<h.length){var i=e.getSelectedPhrase(),j=e.getAroundSelectedText(),k=j.before.slice(-50),l=j.after.slice(0,50);e.displayModal("&hellip;"+k+" <strong>"+h+"</strong> "+l+"&hellip;").on("click","button[role=\"close\"]",function(){e.hideModal()}).on("click",".opentechnology-modal-header-close",function(){e.hideModal()}).on("click","button[role=\"submit\"]",function(){var c=b.call([{methodname:"theme_opentechnology_send_spelling_mistake",args:{url:window.location.toString(),mistake:h,phrase:i,start:k,end:l,comment:a(this).closest(".opentechnology-modal").find("input[name=\"comment\"]").val()}}]);c[0].done(function(){d.addMessage("success",e.label("spelling_mistake_modal_success"))}).fail(function(){if(window.console){d.addMessage("fail",e.label("spelling_mistake_modal_fail"))}}).always(function(){e.hideModal()})})}}},keyupHandler:function keyupHandler(a){var b=this;if(27==a.keyCode){b.hideModal()}},init:function init(){var b=this;b.setStrings();var c=b.keydownHandler.bind(b),d=b.keyupHandler.bind(b);a(document).off("keydown keyup").on("keydown",c).on("keyup",d);a("iframe").each(function(){a(this).on("load",function(){if(this.contentWindow){a(this.contentWindow.document).off("keydown keyup").on("keydown",c).on("keyup",d)}});if(this.contentWindow){a(this.contentWindow.document).off("keydown keyup").on("keydown",c).on("keyup",d)}});if(0<a("#scorm_content").length){var e=new MutationObserver(function(){a("#scorm_content iframe").each(function(){a(this).on("load",function(){var b=this,e=setInterval(function(){if(b.contentWindow){a(b.contentWindow.document).off("keydown keyup").on("keydown",c).on("keyup",d)}},500);setTimeout(function(){clearInterval(e)},5e3)});if(this.contentWindow){a(this.contentWindow.document).off("keydown keyup").on("keydown",c).on("keyup",d)}})});e.observe(a("#scorm_content").get(0),{subtree:!0,attributes:!0,childList:!0,characterData:!0})}}}});
//# sourceMappingURL=spellingmistake.min.js.map
