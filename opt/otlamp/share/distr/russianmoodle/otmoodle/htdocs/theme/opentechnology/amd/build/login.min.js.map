{"version":3,"sources":["../src/login.js"],"names":["define","$","strman","Y","ajax","notification","templates","defaultPageUrl","loginformDescription","dialogueContentReady","Deferred","cleanModalRender","dialogue","cookiebtn","setCookieButton","buttonContent","login","Node","create","addButton","srcNode","action","section","WidgetStdMod","HEADER","replace","getDialogue","state","use","spinner","setAttribute","M","util","image_url","addClass","resolve","core","headerContent","bodyContent","append","draggable","visible","center","modal","width","extraClasses","promise","initDialogue","button","unbind","click","e","preventDefault","localStorage","getItem","customPageurl","data","setItem","alert","alertType","done","set","remove","centered","show","initRedirect","get","document","location","href","setDialogueContent","modalrender","cookierender","cleanCookieRender","setDialogueHeader","header","init","contextid","buttons","pageurl","isloginorsignup","removeItem","each","strings","get_strings","key","component","when","strs","fail","loginform","call","methodname","args","loginformresponse","loginformdata","JSON","parse","render","cookie"],"mappings":"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","sourcesContent":["define(\n    ['jquery', 'core/str', 'core/yui', 'core/ajax', 'core/notification', 'core/templates'],\n    function($, strman, Y, ajax, notification, templates) {\n        return {\n            defaultPageUrl: null,\n            loginformDescription: '',\n            dialogueContentReady: $.Deferred(),\n            cleanModalRender: null,\n            dialogue: $.Deferred(),\n            cookiebtn: null,\n            setCookieButton: function(dialogue, buttonContent) {\n\n                var login = this;\n\n                if (login.cookiebtn === null)\n                {\n                    login.cookiebtn = Y.Node.create('<div></div>');\n                    dialogue.addButton({\n                        srcNode: login.cookiebtn,\n                        action: function(){},\n                        section: Y.WidgetStdMod.HEADER\n                    });\n                    login.cookiebtn.replace(buttonContent);\n                }\n\n            },\n\n\n            getDialogue: function() {\n\n                var login = this;\n\n                if (login.dialogue.state() != 'resolved')\n                {\n                    Y.use('moodle-core-notification', function() {\n\n                        var spinner = Y.Node.create('<img />')\n                            .setAttribute('src', M.util.image_url('i/loading', 'moodle'))\n                            .addClass('spinner');\n\n                        login.dialogue.resolve(new M.core.dialogue({\n                            headerContent: '&nbsp;',\n                            bodyContent: Y.Node.create('<div />').addClass('content-lightbox').append(spinner),\n                            draggable: true,\n                            visible: false,\n                            center: true,\n                            modal: true,\n                            width: '400px',\n                            extraClasses: ['otloginform'],\n                        }));\n\n                    });\n                }\n\n                return login.dialogue.promise();\n            },\n\n\n            initDialogue: function(button){\n\n                var login = this;\n                button.unbind('click').click(function(e){\n\n                    e.preventDefault();\n\n                    if (!localStorage.getItem('otJustRegistered')) {\n                        // пользователь не находится в стадии, когда только что зарегистрировался\n                        // можно затереть вонтсурл и поставить новый\n                        // если затирать всегда, то велик шанс потерять страницу,\n                        // с которой пользователь ушёл на регистрацию\n\n                        // проверяем, есть ли кастомный вонтсурл в дата-атрибуте кнокпки\n                        var customPageurl = $(this).data('customPageurl');\n                        if (customPageurl) {\n                            // кастомный вонтсурл\n                            localStorage.setItem('otLoginWantsUrl', customPageurl);\n                        } else {\n                            // дефолтный вонтсурл (просто страница, на которой мы находимся)\n                            localStorage.setItem('otLoginWantsUrl', login.defaultPageUrl);\n                        }\n                    }\n\n                    var alert = $(this).data('loginformAlert');\n                    if (alert) {\n                        var alertType = $(this).data('loginformAlertType') || 'info';\n                        alert = '<div class=\"alert alert-'+alertType+'\" role=\"alert\">'+alert+'</div>';\n                    } else {\n                        alert = '';\n                    }\n\n                    login.dialogueContentReady.promise().done(function(dialogue){\n                        dialogue.set('bodyContent', alert + login.cleanModalRender);\n                        // после set bodyContent эта гадина зачем-то восстанавливает подмененную мной кнопку\n                        // надо подчистить\n                        $('.moodle-dialogue.otloginform .yui3-widget-buttons > .yui3-button:not(.closebutton)').remove();\n                        dialogue.centered();\n                        dialogue.show();\n                    });\n\n                });\n            },\n\n            initRedirect: function(button){\n\n                var login = this;\n\n                login.getDialogue().done(function(dialogue){\n\n                    if (dialogue.get('visible'))\n                    {\n                        document.location.href = \"/login/\";\n                    }\n                    else\n                    {\n                        button.unbind('click').click(function(){\n                            document.location.href = \"/login/\";\n                        });\n                    }\n                });\n\n            },\n\n            setDialogueContent: function(modalrender, cookierender){\n\n                var login = this;\n\n                login.getDialogue().done(function(dialogue){\n                    login.cleanModalRender = modalrender;\n                    login.cleanCookieRender = cookierender;\n\n                    dialogue.set('bodyContent', modalrender);\n                    login.setCookieButton(dialogue, cookierender);\n                    dialogue.centered();\n\n                    if (login.dialogueContentReady.state() != 'resolved')\n                    {\n                        login.dialogueContentReady.resolve(dialogue);\n                    }\n                });\n\n            },\n\n\n            setDialogueHeader: function(header){\n\n                var login = this;\n                login.getDialogue().done(function(dialogue){\n                    dialogue.set('headerContent', header);\n                });\n\n            },\n\n\n            /**\n             * Базовая инициализация ajax-загрузки\n             */\n            init: function(contextid, buttons, pageurl, isloginorsignup) {\n\n                var login = this;\n\n                if (!isloginorsignup && !localStorage.getItem('otJustRegistered')) {\n                    // очищаем вонтсурл если все-таки не авторизовались и не зарегистрировались,\n                    // а посетили страницу отличную от логина или регистрации\n                    localStorage.removeItem('otLoginWantsUrl');\n                }\n\n                login.defaultPageUrl = pageurl;\n\n                Y.use('moodle-core-notification', function() {\n                    $(buttons).each(function(){\n                        login.initDialogue($(this));\n                    });\n                });\n\n                var strings = strman.get_strings([\n                    { key: 'ajaxpopup_loginheader', component: 'theme_opentechnology' },\n                ]);\n                $.when(strings).done(function(strs){\n                    login.setDialogueHeader(strs[0]);\n                }).fail(function(){\n                    login.setDialogueHeader('Вход');\n                });\n\n                var loginform = ajax.call([{\n                    methodname : 'theme_opentechnology_get_login_form',\n                    args: {}\n                }]);\n                $.when(loginform[0])\n                    .done(function(loginformresponse){\n                        var loginformdata = JSON.parse(loginformresponse);\n\n                        var modal = templates.render('theme_opentechnology/ot-loginform-modal', loginformdata);\n                        var cookie = templates.render('theme_opentechnology/ot-loginform-modal-cookie', loginformdata);\n\n                        $.when(modal, cookie)\n                            .done(function(modalrender, cookierender){\n                                login.setDialogueContent(modalrender[0], cookierender[0]);\n                            }).fail(function(){\n                                login.initRedirect($(buttons));\n                            });\n                    }).fail(function(){\n                        login.initRedirect($(buttons));\n                    });\n            }\n        };\n});"],"file":"login.min.js"}