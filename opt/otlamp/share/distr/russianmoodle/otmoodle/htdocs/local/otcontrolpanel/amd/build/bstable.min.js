define ("local_otcontrolpanel/bstable",["jquery","core/str","core/notification","core/templates","core/fragment","core/modal_factory","core/yui","local_opentechnology/bootstrap-my-table"],function(a,b,c,d,e,f,g,h){function i(){this.table=null;this.toolbar=null;this.selection={};this.contextid=null;this.getDialogue=function(){var b=a.Deferred();g.use("moodle-core-notification",function(){var a=g.Node.create("<img />").setAttribute("src",M.util.image_url("i/loading","moodle")).addClass("spinner");b.resolve(new M.core.dialogue({headerContent:"&nbsp;",bodyContent:g.Node.create("<div />").addClass("content-lightbox").append(a),draggable:!0,visible:!1,center:!0,modal:!0,width:"600px",extraClasses:["otcp_actionform"]}))});return b.promise()};this.loadActionForm=function(b){var c=this,d=[];a.each(c.selection,function(a,b){d.push(b._data["record-id"])});var f={ids:JSON.stringify(d),viewcode:c.table.parents(".view").data("view-code")};if(b!==void 0){f.jsonformdata=b}return e.loadFragment("local_otcontrolpanel","actionform",c.contextid,f)};this.processActionformSubmit=function(b){if("function"==typeof b.preventDefault){b.preventDefault()}var e=b.data.bstable,f=b.data.dialogue,g=a("<img/>").addClass("spinner").attr("src",M.util.image_url("i/loading","moodle")),h=a("<div>").addClass("content-lightbox").append(g);f.set("bodyContent",h.prop("outerHTML"));var j="";if(!(this instanceof i)){j=a(this).serialize()}if("undefined"!=typeof j){var k=JSON.stringify(j),l=e.loadActionForm(k);l.done(function(b,c){var g=a.parseJSON(b),h=g.html,i=g.header;f.set("headerContent",i);var j=a("<div>").addClass("dialogueAction");f.set("bodyContent",j);d.replaceNodeContents(j,h,c);var k=j.find("form.actionform");k.on("submit",{bstable:e,dialogue:f},e.processActionformSubmit);f.centered()});l.fail(c.exception)}};this.actionClickHandle=function(c){c.getDialogue().done(function(d){d.show();d.after("visibleChange",function(){if(!d.get("visible")){d.destroy(!0)}});if(0==Object.keys(c.selection).length){var e=b.get_strings([{key:"action_no_rows_selected",component:"local_otcontrolpanel"},{key:"action_select_rows",component:"local_otcontrolpanel"}]);a.when(e).done(function(a){d.set("headerContent",a[0]);d.set("bodyContent",a[1]);d.centered()})}else{c.processActionformSubmit({data:{bstable:c,dialogue:d}})}})};this.init=function(c,d){var e=this;e.table=a(c);e.contextid=d;e.toolbar=a("<div>").insertBefore(e.table);h.init(e.table,["destroy"]);h.init(e.table,[{locale:"ru-RU",showExport:!0,exportDataType:"all",exportTypes:["json","xml","csv","txt","sql","excel"],refreshOptions:{buttonsOrder:["advancedSearch","executeAction"]},toolbar:e.toolbar,toolbarAlign:"left",onCheck:function onCheck(a,b){e.selection[b.parents("tr").data("index")]=a},onUncheck:function onUncheck(a,b){delete e.selection[b.parents("tr").data("index")]}}]);e.table.on("page-changed.bs.table",function(){a.each(e.selection,function(a){h.init(e.table,["updateCell",{index:a,field:"state",value:!0}])})});var f=b.get_string("action_execute","local_otcontrolpanel");a.when(f).done(function(b){var c=a("<i>").addClass("fa").addClass("fa-bolt").addClass("pr-1"),d=a("<div>").addClass("btn btn-secondary");d.off("click").on("click",function(){e.actionClickHandle(e)});d.append(c);d.append(" "+b);e.toolbar.append(d)})}}return new i});
//# sourceMappingURL=bstable.min.js.map
