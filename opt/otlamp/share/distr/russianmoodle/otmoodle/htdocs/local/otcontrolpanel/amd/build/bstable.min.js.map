{"version":3,"sources":["../src/bstable.js"],"names":["define","$","str","notification","templates","fragment","ModalFactory","Y","bsmt","bstable","table","toolbar","selection","contextid","getDialogue","dialogue","Deferred","use","spinner","Node","create","setAttribute","M","util","image_url","addClass","resolve","core","headerContent","bodyContent","append","draggable","visible","center","modal","width","extraClasses","promise","loadActionForm","jsonformdata","self","ids","each","index","row","push","_data","args","JSON","stringify","viewcode","parents","data","loadFragment","processActionformSubmit","e","preventDefault","attr","wrapper","set","prop","formdata","serialize","fragmentFormAction","done","response","js","decodedresponse","parseJSON","html","header","dialogueBody","replaceNodeContents","form","find","on","centered","fail","exception","actionClickHandle","show","after","get","destroy","Object","keys","length","actionstrsPromise","get_strings","key","component","when","actionstrs","init","bsTableSelector","insertBefore","locale","showExport","exportDataType","exportTypes","refreshOptions","buttonsOrder","toolbarAlign","onCheck","el","onUncheck","field","value","actionstrPromise","get_string","actionstr","icon","actionBtn","off"],"mappings":"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","sourcesContent":["define(\n    [\n        'jquery',\n        'core/str',\n        'core/notification',\n        'core/templates',\n        'core/fragment',\n        'core/modal_factory',\n        'core/yui',\n        'local_opentechnology/bootstrap-my-table'\n    ],\n    function($, str, notification, templates, fragment, ModalFactory, Y, bsmt) {\n        function bstable() {\n            this.table = null;\n            this.toolbar = null;\n            this.selection = {};\n            this.contextid = null;\n            this.getDialogue = function() {\n                var dialogue = $.Deferred();\n\n                Y.use('moodle-core-notification', function() {\n\n                    var spinner = Y.Node.create('<img />')\n                        .setAttribute('src', M.util.image_url('i/loading', 'moodle'))\n                        .addClass('spinner');\n\n                    dialogue.resolve(new M.core.dialogue({\n                        headerContent: '&nbsp;',\n                        bodyContent: Y.Node.create('<div />').addClass('content-lightbox').append(spinner),\n                        draggable: true,\n                        visible: false,\n                        center: true,\n                        modal: true,\n                        width: '600px',\n                        extraClasses: ['otcp_actionform'],\n                    }));\n\n                });\n\n                return dialogue.promise();\n            };\n            this.loadActionForm = function(jsonformdata){\n                var self = this;\n\n                // соберем идентификаторы прочеканных строк в таблице\n                var ids = [];\n                $.each(self.selection, function(index, row){\n                    ids.push(row._data['record-id']);\n                });\n\n                // сформируем аргументы, необходимые для создания формы\n                var args = {\n                    ids: JSON.stringify(ids),\n                    viewcode: self.table.parents('.view').data('view-code'),\n                };\n                // дополним данными самой формы, когда её отправляют (не первая загрузка)\n                if (jsonformdata !== undefined)\n                {\n                    args.jsonformdata = jsonformdata;\n                }\n\n                // запрос на получение формы, возвращающий промис\n                return fragment.loadFragment('local_otcontrolpanel', 'actionform', self.contextid, args);\n            };\n            this.processActionformSubmit = function(e){\n                // на месте e может прилетать всевдоэвент при первой загрузке формы,\n                // поэтому проверяем есть ли у него preventDefault\n                if (typeof e.preventDefault === 'function')\n                {\n                    e.preventDefault();\n                }\n                // собираем данные, прилетевшие с событием\n                var self = e.data.bstable;\n                var dialogue = e.data.dialogue;\n\n                var spinner = $('<img/>')\n                    .addClass('spinner')\n                    .attr('src', M.util.image_url('i/loading', 'moodle'));\n                var wrapper = $('<div>').addClass('content-lightbox').append(spinner);\n                dialogue.set('bodyContent', wrapper.prop('outerHTML'));\n\n\n                // подготавливаем данные формы\n                var formdata = '';\n                if (!(this instanceof bstable))\n                {// мы попали сюда благодаря запуску отправки формы - сериализуем её данные\n                    formdata = $(this).serialize();\n                }\n                if (typeof formdata !== \"undefined\") {\n                    var jsonformdata = JSON.stringify(formdata);\n\n                    // отправляем запрос с данными из формы (если были)\n                    var fragmentFormAction = self.loadActionForm(jsonformdata);\n                    fragmentFormAction.done(function(response, js) {\n                        var decodedresponse = $.parseJSON(response);\n                        var html = decodedresponse.html;\n                        var header = decodedresponse.header;\n\n                        dialogue.set('headerContent', header);\n                        // создаем и кладем его в диалог\n                        var dialogueBody = $('<div>').addClass('dialogueAction');\n                        dialogue.set('bodyContent', dialogueBody);\n\n                        // наполняем созданный элемент кодом формы\n                        templates.replaceNodeContents(dialogueBody, html, js);\n                        // находим саму добавленную на предыдущем шаге форму\n                        var form = dialogueBody.find('form.actionform');\n                        // формируем параметры, из которых станет возможно обратиться к\n                        // главному объекту, диалогу, и нашему элементу, который мы заполняем формой\n                        var formsubmitparams = {\n                            bstable: self,\n                            dialogue: dialogue,\n                        };\n                        // навешиваем своё событие на отправку формы вместо обычного, чтобы\n                        // работала она через аякс\n                        form.on('submit', formsubmitparams, self.processActionformSubmit);\n                        // после наполнения формы данными, отцентрируем её, ведь размеры изменились\n                        dialogue.centered();\n                    });\n                    // ошибок быть не должно, если будут - отображаем через стандартный нотификейшн\n                    fragmentFormAction.fail(notification.exception);\n                }\n            };\n            this.actionClickHandle = function(self){\n                self.getDialogue().done(function(dialogue){\n                    dialogue.show();\n                    dialogue.after(\"visibleChange\", function() {\n                        if (!dialogue.get('visible')) {\n                            dialogue.destroy(true);\n                        }\n                    });\n\n                    if (Object.keys(self.selection).length == 0)\n                    {\n                        // чтобы отображалась загрузка во время запроса строки ошибки,\n                        // воспользуемся этим же диалогом, который уже работает как надо\n                        var actionstrsPromise = str.get_strings([\n                            {\n                                key: 'action_no_rows_selected',\n                                component: 'local_otcontrolpanel'\n                            },\n                            {\n                                key: 'action_select_rows',\n                                component: 'local_otcontrolpanel'\n                            },\n                        ]);\n                        $.when(actionstrsPromise).done(function(actionstrs){\n                            dialogue.set('headerContent', actionstrs[0]);\n                            dialogue.set('bodyContent', actionstrs[1]);\n                            dialogue.centered();\n                        });\n                    } else {\n                        var pseudoevent = {data: {\n                            bstable: self,\n                            dialogue: dialogue\n                        }};\n                        self.processActionformSubmit(pseudoevent);\n                    }\n                });\n            };\n            this.init = function(bsTableSelector, contextid){\n                var self = this;\n                self.table = $(bsTableSelector);\n                self.contextid = contextid;\n\n                self.toolbar = $('<div>').insertBefore(self.table);\n\n\n                bsmt.init(self.table, ['destroy']);\n                bsmt.init(self.table, [{\n                    locale: 'ru-RU',\n                    showExport: true,\n                    exportDataType: 'all',\n                    exportTypes: ['json', 'xml', 'csv', 'txt', 'sql', 'excel'],\n                    refreshOptions: {\n                        buttonsOrder: ['advancedSearch', 'executeAction']\n                    },\n                    toolbar: self.toolbar,\n                    toolbarAlign: 'left',\n                    onCheck: function(row, el){\n                        self.selection[el.parents('tr').data('index')] = row;\n                    },\n                    onUncheck: function(row, el){\n                        delete self.selection[el.parents('tr').data('index')];\n                    }\n                }]);\n\n                self.table.on('page-changed.bs.table', function(){\n                    $.each(self.selection, function(index){\n                        bsmt.init(self.table, [\n                            'updateCell',\n                            {\n                                index: index,\n                                field: 'state',\n                                value: true\n                            }\n                        ]);\n                    });\n                });\n\n                var actionstrPromise = str.get_string('action_execute', 'local_otcontrolpanel');\n                $.when(actionstrPromise).done(function(actionstr){\n                    var icon = $('<i>').addClass('fa').addClass('fa-bolt').addClass('pr-1');\n                    var actionBtn = $('<div>').addClass('btn btn-secondary');\n                    actionBtn.off('click').on('click', function(){ self.actionClickHandle(self); });\n                    actionBtn.append(icon);\n                    actionBtn.append(' '+actionstr);\n                    self.toolbar.append(actionBtn);\n                });\n            };\n        }\n        return new bstable();\n    }\n);"],"file":"bstable.min.js"}