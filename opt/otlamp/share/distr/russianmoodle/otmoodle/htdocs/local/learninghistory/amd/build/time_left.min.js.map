{"version":3,"sources":["../src/time_left.js"],"names":["define","$","ajax","templates","_timer","_delay","_userid","_courseid","_totaltime","startRefresh","refresh","setInterval","_refreshTimer","stopRefresh","clearInterval","response","call","methodname","args","done","activetimedata","parseJSON","t","getTimeRemaining","activetime","activetimestr","total","rusDateInterval","templatedata","atlastupdate","render","then","html","js","replaceNodeContents","fail","ex","window","console","log","message","seconds","Math","floor","minutes","hours","days","format","push","rusNum","join","num","word","init","delay","totaltime","userid","courseid","parseInt","isNaN","blur","focus"],"mappings":"AAAAA,OAAM,mCAAC,CAAC,QAAD,CAAW,WAAX,CAAwB,gBAAxB,CAAD,CAA4C,SAASC,CAAT,CAAYC,CAAZ,CAAkBC,CAAlB,CAA6B,CAC3E,MAAO,CACHC,MAAM,CAAE,IADL,CAEHC,MAAM,CAAE,IAFL,CAGHC,OAAO,CAAG,IAHP,CAIHC,SAAS,CAAE,IAJR,CAKHC,UAAU,CAAE,CALT,CAMHC,YAAY,CAAE,uBAAW,CACrB,GAAIC,CAAAA,CAAO,CAAG,IAAd,CAEAA,CAAO,CAACN,MAAR,CAAiBO,WAAW,CAAC,UAAW,CACpCD,CAAO,CAACE,aAAR,EACH,CAF2B,CAEzBF,CAAO,CAACL,MAFiB,CAG/B,CAZE,CAcHQ,WAAW,CAAE,sBAAW,CACpB,GAAIH,CAAAA,CAAO,CAAG,IAAd,CAEAI,aAAa,CAACJ,CAAO,CAACN,MAAT,CAChB,CAlBE,CAoBHQ,aAAa,CAAE,wBAAW,IAClBF,CAAAA,CAAO,CAAG,IADQ,CAElBK,CAAQ,CAAGb,CAAI,CAACc,IAAL,CAAU,CAAC,CACtBC,UAAU,CAAG,8CADS,CAEtBC,IAAI,CAAE,CACF,OAAUR,CAAO,CAACJ,OADhB,CAEF,SAAYI,CAAO,CAACH,SAFlB,CAFgB,CAAD,CAAV,CAFO,CAStBQ,CAAQ,CAAC,CAAD,CAAR,CACKI,IADL,CACU,SAASJ,CAAT,CAAmB,IACjBK,CAAAA,CAAc,CAAGnB,CAAC,CAACoB,SAAF,CAAYN,CAAZ,CADA,CAEjBO,CAAC,CAAGZ,CAAO,CAACa,gBAAR,CAAyBH,CAAc,CAACI,UAAxC,CAFa,CAIjBC,CAJiB,CAKrB,GAAc,CAAV,CAAAH,CAAC,CAACI,KAAF,EAA4B,CAAZ,GAAAJ,CAAC,CAACI,KAAF,EAAwC,CAAvB,GAAAhB,CAAO,CAACF,UAA7C,CACA,CACIiB,CAAa,CAAGf,CAAO,CAACiB,eAAR,CAAwBL,CAAxB,CACnB,CAHD,IAIA,CACIR,aAAa,CAACJ,CAAO,CAACN,MAAT,CAAb,CACAqB,CAAa,CAAG,+DACnB,CAED,GAAIG,CAAAA,CAAY,CAAG,CACf,cAAiBH,CADF,CAEf,aAAgBL,CAAc,CAACS,YAFhB,CAAnB,CAIA1B,CAAS,CAAC2B,MAAV,CAAiB,gCAAjB,CAAmDF,CAAnD,EACKG,IADL,CACU,SAASC,CAAT,CAAeC,CAAf,CAAmB,CACrB9B,CAAS,CAAC+B,mBAAV,CAA8BjC,CAAC,CAAC,yDAAD,CAA/B,CAA4F+B,CAA5F,CAAkGC,CAAlG,CACH,CAHL,CAIH,CAvBL,EAwBKE,IAxBL,CAwBU,SAASC,CAAT,CAAa,CAEfC,MAAM,CAACC,OAAP,CAAeC,GAAf,CAAmBH,CAAE,CAACI,OAAtB,CACH,CA3BL,CA4BH,CAzDE,CA2DHjB,gBAAgB,CAAE,0BAAUC,CAAV,CAAsB,IAChCd,CAAAA,CAAO,CAAG,IADsB,CAEhCY,CAFgC,CAGpC,GAAyB,CAArB,CAAAZ,CAAO,CAACF,UAAZ,CACA,CACIc,CAAC,CAAGZ,CAAO,CAACF,UAAR,CAAqBgB,CAAzB,CACA,GAAS,CAAJ,CAAAF,CAAL,CACA,CACIA,CAAC,CAAG,CACP,CACJ,CAPD,IAQA,CACIA,CAAC,CAAGE,CACP,CAbmC,GAehCiB,CAAAA,CAAO,CAAGC,IAAI,CAACC,KAAL,CAAarB,CAAD,CAAM,EAAlB,CAfsB,CAgBhCsB,CAAO,CAAGF,IAAI,CAACC,KAAL,CAAarB,CAAC,CAAC,EAAH,CAAS,EAArB,CAhBsB,CAiBhCuB,CAAK,CAAGH,IAAI,CAACC,KAAL,CAAarB,CAAC,KAAF,CAAc,EAA1B,CAjBwB,CAkBhCwB,CAAI,CAAGJ,IAAI,CAACC,KAAL,CAAYrB,CAAC,MAAb,CAlByB,CAmBpC,MAAO,CACH,MAASA,CADN,CAEH,KAAQwB,CAFL,CAGH,MAASD,CAHN,CAIH,QAAWD,CAJR,CAKH,QAAWH,CALR,CAOV,CArFE,CAuFHd,eAAe,CAAE,yBAASL,CAAT,CAAY,IACrBZ,CAAAA,CAAO,CAAG,IADW,CAErBqC,CAAM,CAAG,EAFY,CAIzB,GAAc,CAAX,GAAAzB,CAAC,CAACwB,IAAL,CAAiB,CACbC,CAAM,CAACC,IAAP,CAAYtC,CAAO,CAACuC,MAAR,CAAe3B,CAAC,CAACwB,IAAjB,CAAuB,CAAC,0BAAD,CAAQ,oBAAR,CAAc,0BAAd,CAAvB,CAAZ,CACH,CACD,GAAe,CAAZ,GAAAxB,CAAC,CAACuB,KAAL,CAAkB,CACdE,CAAM,CAACC,IAAP,CAAYtC,CAAO,CAACuC,MAAR,CAAe3B,CAAC,CAACuB,KAAjB,CAAwB,CAAC,oBAAD,CAAO,0BAAP,CAAc,gCAAd,CAAxB,CAAZ,CACH,CACD,GAAiB,CAAd,GAAAvB,CAAC,CAACsB,OAAL,CAAoB,CAChBG,CAAM,CAACC,IAAP,CAAYtC,CAAO,CAACuC,MAAR,CAAe3B,CAAC,CAACsB,OAAjB,CAA0B,CAAC,sCAAD,CAAU,sCAAV,CAAmB,gCAAnB,CAA1B,CAAZ,CACH,CACD,GAAc,CAAX,GAAAtB,CAAC,CAACwB,IAAF,EAA4B,CAAZ,GAAAxB,CAAC,CAACuB,KAAlB,EAA+C,CAAd,GAAAvB,CAAC,CAACsB,OAAtC,CAAqD,CACjDG,CAAM,CAACC,IAAP,CAAYtC,CAAO,CAACuC,MAAR,CAAe3B,CAAC,CAACmB,OAAjB,CAA0B,CAAC,4CAAD,CAAW,4CAAX,CAAqB,sCAArB,CAA1B,CAAZ,CACH,CAED,MAAOM,CAAAA,CAAM,CAACG,IAAP,CAAY,GAAZ,CACV,CAzGE,CA2GHD,MAAM,CAAE,gBAASE,CAAT,CAAcC,CAAd,CAAoB,CACxB,GAAgB,CAAZ,EAAAD,CAAG,CAAG,EAAN,EAA8B,EAAb,EAAAA,CAAG,CAAG,GAA3B,CACA,CACG,MAAOA,CAAAA,CAAG,CAAG,GAAN,CAAYC,CAAI,CAAC,CAAD,CACzB,CAHD,IAGO,IAAgB,CAAZ,EAAAD,CAAG,CAAG,EAAN,EAA6B,CAAZ,EAAAA,CAAG,CAAG,EAAvB,GAA+C,EAAZ,CAAAA,CAAG,CAAG,GAAN,EAA8B,EAAZ,CAAAA,CAAG,CAAG,GAA3D,CAAJ,CACP,CACG,MAAOA,CAAAA,CAAG,CAAG,GAAN,CAAYC,CAAI,CAAC,CAAD,CACzB,CAHM,IAIP,CACG,MAAOD,CAAAA,CAAG,CAAG,GAAN,CAAYC,CAAI,CAAC,CAAD,CACzB,CACJ,CAtHE,CA2HHC,IAAI,CAAE,cAASC,CAAT,CAAgBC,CAAhB,CAA2BC,CAA3B,CAAmCC,CAAnC,CAA6C,CAE/C,KAAKpD,MAAL,CAAgC,GAAlB,CAAAqD,QAAQ,CAACJ,CAAD,CAAtB,CACA,GAAGK,KAAK,CAAC,KAAKtD,MAAN,CAAL,EAAoC,GAAd,MAAKA,MAA9B,CACA,CAEI,KAAKA,MAAL,CAAc,GACjB,CACD,KAAKC,OAAL,CAAekD,CAAf,CACA,KAAKjD,SAAL,CAAiBkD,CAAjB,CACA,KAAKjD,UAAL,CAAkB+C,CAAlB,CACA,GAAI7C,CAAAA,CAAO,CAAG,IAAd,CAEAA,CAAO,CAACE,aAAR,GAEAX,CAAC,CAAC,UAAW,CAETS,CAAO,CAACD,YAAR,GACAR,CAAC,CAACoC,MAAD,CAAD,CAAUuB,IAAV,CAAe,UAAW,CAEtBlD,CAAO,CAACG,WAAR,EACH,CAHD,EAIAZ,CAAC,CAACoC,MAAD,CAAD,CAAUwB,KAAV,CAAgB,UAAW,CAEvBnD,CAAO,CAACD,YAAR,EACH,CAHD,CAIH,CAXA,CAYJ,CAtJE,CAwJV,CAzJK,CAAN","sourcesContent":["define(['jquery', 'core/ajax', 'core/templates'], function($, ajax, templates) {\n    return {\n        _timer: null,\n        _delay: null,\n        _userid : null,\n        _courseid: null,\n        _totaltime: 0,\n        startRefresh: function() {\n            var refresh = this;\n            // Запускаем повторение функции _refreshTimer с интервалом refresh._delay\n            refresh._timer = setInterval(function() {\n                refresh._refreshTimer();\n            }, refresh._delay);\n        },\n\n        stopRefresh: function() {\n            var refresh = this;\n            // Отключаем повторение вызовов функции в setInterval\n            clearInterval(refresh._timer);\n        },\n\n        _refreshTimer: function() {\n            var refresh = this;\n            var response = ajax.call([{\n                methodname : 'local_learninghistory_get_current_activetime',\n                args: {\n                    'userid': refresh._userid,\n                    'courseid': refresh._courseid\n                }\n            }]);\n            response[0]\n                .done(function(response) {\n                    var activetimedata = $.parseJSON(response);\n                    var t = refresh.getTimeRemaining(activetimedata.activetime);\n\n                    var activetimestr;\n                    if( t.total > 0 || (t.total === 0 && refresh._totaltime === 0) )\n                    {\n                        activetimestr = refresh.rusDateInterval(t);\n                    } else\n                    {\n                        clearInterval(refresh._timer);\n                        activetimestr = 'Время вышло';\n                    }\n\n                    var templatedata = {\n                        'activetimestr': activetimestr,\n                        'atlastupdate': activetimedata.atlastupdate\n                    };\n                    templates.render('local_learninghistory/timeleft', templatedata)\n                        .then(function(html, js) {\n                            templates.replaceNodeContents($('.block.activetimer > .card-body > .card-text > .content'), html, js);\n                        });\n                })\n                .fail(function(ex) {\n                    // Если получили ошибку при обработке аякс запроса - выведем стек в консоль\n                    window.console.log(ex.message);\n                });\n        },\n\n        getTimeRemaining: function (activetime) {\n            var refresh = this;\n            var t;\n            if( refresh._totaltime > 0 )\n            {\n                t = refresh._totaltime - activetime;\n                if ( t < 0 )\n                {\n                    t = 0;\n                }\n            } else\n            {\n                t = activetime;\n            }\n\n            var seconds = Math.floor( (t) % 60 );\n            var minutes = Math.floor( (t/60) % 60 );\n            var hours = Math.floor( (t/(60*60)) % 24 );\n            var days = Math.floor( t/(60*60*24) );\n            return {\n                'total': t,\n                'days': days,\n                'hours': hours,\n                'minutes': minutes,\n                'seconds': seconds\n            };\n        },\n\n        rusDateInterval: function(t) {\n            var refresh = this;\n            var format = [];\n\n            if(t.days !== 0) {\n                format.push(refresh.rusNum(t.days, ['день','дня','дней']));\n            }\n            if(t.hours !== 0) {\n                format.push(refresh.rusNum(t.hours, ['час','часа','часов']));\n            }\n            if(t.minutes !== 0) {\n                format.push(refresh.rusNum(t.minutes, ['минута','минуты','минут']));\n            }\n            if(t.days === 0 && t.hours === 0 && t.minutes === 0) {\n                format.push(refresh.rusNum(t.seconds, ['секунда','секунды','секунд']));\n            }\n\n            return format.join(' ');\n        },\n\n        rusNum: function(num, word) {\n            if (num % 10 == 1 && num % 100 != 11)\n            {\n               return num + ' ' + word[0];\n            } else if (num % 10 >= 2 && num % 10 <= 4 && (num % 100 < 11 || num % 100 > 14) )\n            {\n               return num + ' ' + word[1];\n            } else\n            {\n               return num + ' ' + word[2];\n            }\n        },\n\n        /**\n         * Базовая инициализация\n         */\n        init: function(delay, totaltime, userid, courseid) {\n            // Задержка должна быть в милисекундах\n            this._delay = parseInt(delay) * 1000;\n            if(isNaN(this._delay) || this._delay < 20000)\n            {// Если задержка между запросами не пришла или меньше 20 сек\n                // Выставим принудительно 20 сек (чаще нет смысла, запуск крона чаще раза в минуту не происходит)\n                this._delay = 20000;\n            }\n            this._userid = userid;\n            this._courseid = courseid;\n            this._totaltime = totaltime;\n            var refresh = this;\n\n            refresh._refreshTimer();\n\n            $(function() {\n                // Запуск аякса после загрузки страницы\n                refresh.startRefresh();\n                $(window).blur(function() {\n                    // При переключении вкладки перестаем посылать аякс запросы\n                    refresh.stopRefresh();\n                });\n                $(window).focus(function() {\n                    // При возврате во вкладку снова включаем отправку аякс запросов\n                    refresh.startRefresh();\n                });\n            });\n        }\n    };\n});"],"file":"time_left.min.js"}