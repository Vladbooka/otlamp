{"version":3,"sources":["../src/activetime_controller.js"],"names":["define","ajax","$","_timer","_delay","_userid","_courseid","_contextid","_overiframe","startMonitoring","atmon","removeClass","addClass","_changeActivetime","setInterval","response","call","methodname","args","fail","ex","window","console","log","message","stopMonitoring","clearInterval","init","delay","userid","courseid","contextid","parseInt","isNaN","vis","stateKey","eventKey","keys","hidden","webkitHidden","mozHidden","msHidden","document","c","addEventListener","setTimeout","notIE","documentMode","isChromium","chrome","on","attachEvent","event","data","ctx","focus"],"mappings":"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","sourcesContent":["define(['core/ajax', 'jquery'], function(ajax, $) {\n    return {\n        _timer: null,\n        _delay: null,\n        _userid : null,\n        _courseid: null,\n        _contextid: null,\n        _overiframe: false,\n        startMonitoring: function() {\n            var atmon = this;\n            // включаем позитивную индикацию (пользователь должен видеть, что подсчет времени идет)\n            $('.block.activetimer').removeClass('noprogress').addClass('inprogress');\n            atmon._changeActivetime();\n            // Запускаем повторение функции _changeActivetime с интервалом atmon._delay\n            atmon._timer = setInterval(function() {\n                atmon._changeActivetime();\n            }, atmon._delay);\n        },\n        _changeActivetime: function() {\n            var atmon = this;\n            // Отправим аякс запрос нашему обработчику на бэкенде\n            var response = ajax.call([{\n                methodname : 'local_learninghistory_add_activetime_updated_log',\n                args: {\n                    'userid': atmon._userid,\n                    'courseid': atmon._courseid,\n                    'contextid': atmon._contextid\n                }\n            }]);\n            response[0]\n                .fail(function(ex) {\n                    // Если получили ошибку при обработке аякс запроса - выведем стек в консоль\n                    window.console.log(ex.message);\n                });\n        },\n        stopMonitoring: function() {\n            var atmon = this;\n            if (atmon._overiframe) {\n                // во время потери фокуса курсор был над iframe\n                // считаем что мы по прежнему на странице и не отключаем мониторинг\n                return;\n            }\n            // отключаем позитивную индикацию (пользователь должен видеть, что подсчет времени больше не идет)\n            $('.block.activetimer').removeClass('inprogress').addClass('noprogress');\n            // Отключаем повторение вызовов функции в setInterval\n            clearInterval(atmon._timer);\n        },\n        /**\n         * Базовая инициализация\n         */\n        init: function(delay, userid, courseid, contextid) {\n            // Задержка должна быть в милисекундах\n            this._delay = parseInt(delay) * 1000;\n            if(isNaN(this._delay) || this._delay < 10000)\n            {// Если задержка между запросами не пришла или меньше 10 сек\n                // Выставим принудительно 10 сек\n                this._delay = 10000;\n            }\n            this._userid = userid;\n            this._courseid = courseid;\n            this._contextid = contextid;\n\n            var atmon = this;\n\n            var vis = (function(){\n                var stateKey,\n                    eventKey,\n                    keys = {\n                            hidden: \"visibilitychange\",\n                            webkitHidden: \"webkitvisibilitychange\",\n                            mozHidden: \"mozvisibilitychange\",\n                            msHidden: \"msvisibilitychange\"\n                };\n                for (stateKey in keys) {\n                    if (stateKey in document) {\n                        eventKey = keys[stateKey];\n                        break;\n                    }\n                }\n                return function(c) {\n                    if (c) {document.addEventListener(eventKey, c);}\n                    return !document[stateKey];\n                };\n            })();\n\n            vis(function(){\n                if(vis()){\n                    setTimeout(function(){\n                        atmon.stopMonitoring();\n                        atmon.startMonitoring();\n                    },300);\n                } else {\n                    atmon.stopMonitoring();\n                }\n            });\n\n            $(function(){\n                atmon.startMonitoring();\n            });\n\n            var notIE = (document.documentMode === undefined),\n                isChromium = window.chrome;\n            if (notIE && !isChromium) {\n\n                // checks for Firefox and other  NON IE Chrome versions\n                $(window).on(\"focusin\", function () {\n                    atmon.stopMonitoring();\n                    atmon.startMonitoring();\n                }).on(\"focusout\", function () {\n                    atmon.stopMonitoring();\n                });\n            } else\n            {\n                // checks for IE and Chromium versions\n                if (window.addEventListener) {\n                    // bind focus event\n                    window.addEventListener(\"focus\", function () {\n                        atmon.stopMonitoring();\n                        atmon.startMonitoring();\n                    }, false);\n\n                    // bind blur event\n                    window.addEventListener(\"blur\", function () {\n                        atmon.stopMonitoring();\n                    }, false);\n\n                } else {\n                    // bind focus event\n                    window.attachEvent(\"focus\", function () {\n                        atmon.stopMonitoring();\n                        atmon.startMonitoring();\n                    });\n\n                    // bind focus event\n                    window.attachEvent(\"blur\", function () {\n                        atmon.stopMonitoring();\n                    });\n                }\n            }\n            // попытка отслеживать курсор над iframe чтобы игнорировать потерю фокуса в него\n            $('iframe').on('mouseover', {'ctx': atmon}, function(event) {\n                var atmon = event.data.ctx;\n                atmon._overiframe = true;\n            });\n            $('iframe').on('mouseout', {'ctx': atmon}, function(event) {\n                var atmon = event.data.ctx;\n                atmon._overiframe = false;\n                $(window).focus();\n            });\n        }\n    };\n});"],"file":"activetime_controller.min.js"}