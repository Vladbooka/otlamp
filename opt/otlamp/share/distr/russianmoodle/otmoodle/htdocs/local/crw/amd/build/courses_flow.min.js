define(["jquery","core/ajax","core/str","core/notification"],function(a,b,c,d){var e=function(b,d,e,f,g,h,i,j,k,l){this.__instance=b,this.__categoryId=d,this.__currentPage=e,this.__perPage=f,this.__countItems=g,this.__loadedCourses=f,this.__displayFromSubcategories=i,this.__searchquery=j,this.__userid=k,this.__usercoursesnotactive=l;var m=this;if(this.__countItems>0){this.__showmorebutton=a("<span>").addClass("local_crw_show_more_button").insertAfter(this.__instance),this.__showmorebutton.wrap('<div class="local_crw_show_more"></div>');var n=c.get_string("courses_flow_show_more","local_crw");a.when(n).done(function(a){m.__showmorebutton.text(a).click(function(){m.showMore()})});var o=a("<span>").addClass("local_crw_show_more_loader").insertAfter(this.__showmorebutton),p=c.get_string("courses_flow_loading","local_crw");a.when(p).done(function(a){o.text(a)}),this.showMore(),this.__perPage>this.__countItems&&this.__instance.parent().find(".local_crw_top_paging_description span").text(this.__countItems),h&&a(document).scroll(function(){a(document).scrollTop()+a(window).height()>=m.__showmorebutton.offset().top&&m.showMore()})}};return e.prototype.__categoryId=0,e.prototype.__currentPage=0,e.prototype.__perPage=8,e.prototype.__loadedCourses=8,e.prototype.__countItems=0,e.prototype.__displayFromSubcategories=null,e.prototype.__slot=void 0,e.prototype.__showmorebutton=void 0,e.prototype.__nextPageContent=a("<div>"),e.prototype.__userid=null,e.prototype.__usercoursesnotactive=null,e.prototype.loadNextPageContent=function(){var c=this;if(Math.ceil(c.__countItems/c.__perPage)<=c.__currentPage&&c.__showmorebutton.parent().addClass("out-of-items").removeClass("loading"),!c.__showmorebutton.parent().hasClass("out-of-items")){c.__nextPageContent=a("<div>").addClass("local-crw_next-page-preload").addClass("local-crw_next-page-empty").appendTo(c.__instance);var e={plugincode:c.__instance.parent().data("plugin-code"),categoryid:c.__categoryId,perpage:c.__perPage,page:++c.__currentPage,params:JSON.stringify(c.getGet()),displayfromsubcategories:c.__displayFromSubcategories,searchquery:c.__searchquery};null!==c.__userid&&(e.userid=c.__userid),null!==c.__usercoursesnotactive&&(e.usercoursesnotactive=c.__usercoursesnotactive);var f=b.call([{methodname:"local_crw_get_courses",args:e}]);f[0].done(function(b){var d=a.parseJSON(b),e=d.html;d.num_loaded_courses>0?(c.__loadedCourses=c.__loadedCourses+d.num_loaded_courses,c.__nextPageContent.removeClass("local-crw_next-page-empty").append(e),c.__showmorebutton.parent().hasClass("loading")&&c.showPreloadedPage()):c.__showmorebutton.parent().addClass("out-of-items").removeClass("loading")}).fail(d.exception)}},e.prototype.getGet=function(){var a={};return window.location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(b,c,d){a[c]=decodeURIComponent(d)}),a},e.prototype.showPreloadedPage=function(){var a=this;a.__showmorebutton.parent().removeClass("loading"),a.__nextPageContent.removeClass("local-crw_next-page-preload"),a.markCurrentPage(),a.loadNextPageContent()},e.prototype.markCurrentPage=function(){var b=this;b.__instance.parent().find(".paging").each(function(){a(this).children("*:not(.previous):not(.next):not(.first):not(.last)").eq(b.__currentPage).addClass("current-page"),a(this).children("*.next").click(function(b){b.preventDefault();var c=a(this).parent().children(".current-page").last().next("*:not(.previous):not(.next):not(.first):not(.last)");c.length>0&&(window.location.href=c.attr("href"))}),a(this).children("*.previous").click(function(b){b.preventDefault();var c=a(this).parent().children(".current-page").first().prev("*:not(.previous):not(.next):not(.first):not(.last)");c.length>0&&(window.location.href=c.attr("href"))})}),b.__instance.parent().find(".local_crw_top_paging_description span").text(b.__loadedCourses)},e.prototype.showMore=function(){var a=this;a.__nextPageContent.hasClass("local-crw_next-page-empty")?a.__showmorebutton.parent().addClass("loading"):a.showPreloadedPage()},{init:function(b,c,d,f,g,h,i,j,k,l){a('#local_crw[data-object-id="'+b+'"] .crw_ptype_10 .crw_plugin_body').each(function(){return new e(a(this),c,d,f,g,h,i,j,k,l)})}}});