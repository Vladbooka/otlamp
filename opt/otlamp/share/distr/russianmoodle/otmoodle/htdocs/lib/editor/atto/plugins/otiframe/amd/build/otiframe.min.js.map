{"version":3,"sources":["../src/otiframe.js"],"names":["adjustWidth","ignoreDiffWidth","changesInSequence","init","each","index","otiframe","source","attr","dataSource","data","localurl","encodeURIComponent","removeAttr","on","addClass","otiframeAutoHeight","setChangesCounter","window","onresize","addEventListener","processFrameMessage","heightChanges","widthChanges","hasClass","style","height","contentWindow","document","body","scrollHeight","width","scrollWidth","event","frameWidth","frameHeight","hasOwnProperty","sourceFrame","getFrameMessageOwner","clearTimeout","setTimeout","diffHeight","allowedDiff","console","log","diffWidth","myFrames","getElementsByTagName","eventSource","eventOrigin","origin","i","f","length","parent","src","indexOf"],"mappings":"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","sourcesContent":["import $ from 'jquery';\n\n// При установке высоты фрейма точь-в-точь, как пришло изнутри, может выйти так, что по ширине контент не умещается.\n// Из-за этого появляется полоса прокрутки. Из-за этого уже и по высоте не помещается - появляется еще одна прокрутка.\n// Поэтому мы делаем высоту фрейма больше на размер указанный здесь, в extraHeight.\n// Но как следствие документ отображаемый в iframe может отловить изменение размера и послать вновь модифицированный размер.\n// Поэтому это же значение используется и в качестве порога изменения высоты, на которое мы не реагируем.\n// Если высота увеличилась менее чем на 30px - ничего не делаем. Больше или уменьшилась - ставим переданную + extraHeight.\nconst extraHeight = 30;\n\n// Требуется ли пытаться подстраивать ширину под контент\n// По умолчанию ширина 100%\n// Пока опция отключена, так как при уменьшении ширины, обратно контент не попросится стать шире\nconst adjustWidth = false;\n\n// Есть пример, когда документ внутри iframe при изменении размера iframe зачем-то меняет свою ширину (obed.ru)\n// Передает ширину - ставим её, ловит изменение - передает значение поменьше и т.д., пока не получится мобильный вид :)\n// На такой случай теперь имеется вот такая константа, определяющая порог изменения ширины, меньше которого мы не реагируем.\nconst ignoreDiffWidth = 20;\n\n// В случае, если циклическое изменение размеров все же запускается, разработан защитный механизм\n// Он не позволяет запускать последовательно изменение размеров больше указанного в этой константе количества раз\n// Этот счетчик сбрасывается при изменении размеров окна и по таймеру\nconst changesInSequence = 5;\n\n// Счетчик changesInSequence сбрасывается при изменении размеров окна и по таймеру\n// Задержка перед сбросом счетчика указывается в константе delayToClearAfterSequence\nconst delayToClearAfterSequence = 100;\n\n/**\n* Обработка otiframe'ов.\n*/\nexport const init = () => {\n\n    /*\n     * мы не можем в редакторе сразу задать src, так как в него будет положен draftfile,\n     * у которого принудительно forcedownload,\n     * поэтому перекладываем путь из data-source в src\n     */\n    $('.otiframe').each((index, otiframe) => {\n        var source = $(otiframe).attr('src');\n        var sourceDefined = (typeof source !== 'undefined' && source !== false);\n        var dataSource = $(otiframe).data('source');\n        var dataSourceDefined = (typeof dataSource !== 'undefined' && dataSource !== false);\n        if (!sourceDefined && dataSourceDefined) {\n            /* направляем на проксирующий скрипт, в котором планируем в будущем задавать высоту */\n            var localurl = '/lib/editor/atto/plugins/otiframe/file.php?ois='+encodeURIComponent(dataSource);\n            $(otiframe)\n                .removeAttr('srcdoc')\n                .attr({\n                    'src': localurl,\n                    'frameborder': 0\n                })\n                .on('load', function(){\n                    $(this).addClass('loaded');\n                    otiframeAutoHeight(this);\n                });\n            setChangesCounter(otiframe, 0, 0);\n        }\n    });\n\n    // При изменении размеров окна сбрасываем счетчик изменений,\n    // чтобы вновь обработать сообщение фрейма что бы ни было ранее\n    window.onresize = function(){\n        $('.otiframe').each((index, otiframe) => {\n            setChangesCounter(otiframe, 0, 0);\n            otiframeAutoHeight(otiframe);\n        });\n    };\n    // Обработчик сообщений из iframe\n    window.addEventListener('message', processFrameMessage);\n};\n\nconst setChangesCounter = (otiframe, heightChanges, widthChanges) => {\n    $(otiframe).data('heightChanges', heightChanges);\n    $(otiframe).data('widthChanges', widthChanges);\n};\n\nconst otiframeAutoHeight = (otiframe) => {\n    if ($(otiframe).hasClass('autosize')) {\n        // Попытка установки размеров iframe по контенту. Может не работать с cross-origin\n        otiframe.style.height = (otiframe.contentWindow.document.body.scrollHeight + extraHeight) + 'px';\n        if (adjustWidth) {\n            otiframe.style.width = otiframe.contentWindow.document.body.scrollWidth + 'px';\n        }\n    }\n};\n\n/**\n * Обработчик сообщений из iframe\n */\nconst processFrameMessage = (event) => {\n\n    var frameWidth=null, frameHeight=null;\n\n    if (event.data.hasOwnProperty('frameHeight')) {\n        frameHeight = event.data.frameHeight;\n    }\n    if (event.data.hasOwnProperty('frameWidth')) {\n        frameWidth = event.data.frameWidth;\n    }\n    if (frameWidth === null && frameHeight === null) {\n        return;\n    }\n\n    // Определение DOM-элемента, приславшего сообщение\n    var sourceFrame = getFrameMessageOwner(event);\n    if (sourceFrame === null) {\n        return;\n    }\n\n    if ($(sourceFrame).hasClass('autosize')) {\n\n        // Очистка счетчика количества изменений по таймеру\n        if ($(sourceFrame).data('inactiveTimer')) {\n            clearTimeout($(sourceFrame).data('inactiveTimer'));\n        }\n        $(sourceFrame).data('inactiveTimer', setTimeout(function(){\n            setChangesCounter(sourceFrame, 0, 0);\n        }, delayToClearAfterSequence));\n\n        var heightChanges = $(sourceFrame).data('heightChanges');\n        var widthChanges = $(sourceFrame).data('widthChanges');\n\n        // изменение высоты\n        if (frameHeight !== null) {\n            var diffHeight = frameHeight - sourceFrame.scrollHeight;\n            var allowedDiff = (diffHeight < 0 || diffHeight > extraHeight);\n            window.console.log(sourceFrame, frameHeight, sourceFrame.scrollHeight, allowedDiff, heightChanges, changesInSequence);\n            if (allowedDiff && heightChanges < changesInSequence) {\n                sourceFrame.style.height = (frameHeight+extraHeight)+'px';\n                heightChanges++;\n            }\n        }\n\n        // Изменение ширины\n        if (frameWidth !== null && adjustWidth) {\n            var diffWidth = frameWidth - sourceFrame.scrollWidth;\n            var allowedDiff = (diffWidth < -ignoreDiffWidth || diffWidth > ignoreDiffWidth);\n            if (allowedDiff && widthChanges < changesInSequence) {\n                sourceFrame.style.width = frameWidth+'px';\n                widthChanges++;\n            }\n        }\n\n        // Обновление счетчика изменений размеров\n        setChangesCounter(sourceFrame, heightChanges, widthChanges);\n    }\n};\n\n/**\n * Определение DOM-элемента, приславшего сообщение\n */\nconst getFrameMessageOwner = (event) => {\n\n    var sourceFrame = null; // this is the IFRAME which send the postMessage\n\n    var myFrames = document.getElementsByTagName(\"IFRAME\");\n    var eventSource = event.source; // event is the event raised by the postMessage\n    var eventOrigin = event.origin; // origin domain, e.g. http://example.com\n\n    // detect the source for IFRAMEs with same-origin URL\n    for (var i=0; i<myFrames.length; i++) {\n        var f = myFrames[i];\n        if (f.contentWindow==eventSource || // for absolute URLs\n            f.contentWindow==eventSource.parent) { // for relative URLs\n            sourceFrame = f;\n            break;\n        }\n    }\n\n    // detect the source for IFRAMEs with cross-origin URL\n    // (because accessing/comparing event.source properties is not allowed for cross-origin URL)\n    if (sourceFrame === null) {\n        for (var i=0; i<myFrames.length; i++) {\n            if (myFrames[i].src.indexOf(eventOrigin)==0) {\n                sourceFrame = myFrames[i];\n                break;\n            }\n        }\n    }\n\n    return sourceFrame;\n};"],"file":"otiframe.min.js"}